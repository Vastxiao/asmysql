# GitHub Actionsï¼š
#   è‡ªåŠ¨Pythonæ‰“åŒ…æ¨é€åˆ°PyPI
# (1)é€šè¿‡pypiçš„api-tokenå‘å¸ƒçš„æ–¹å¼:
#     - name: Publish Distribution ğŸ“¦ To PyPI
#       uses: pypa/gh-action-pypi-publish@release/v1
#       with:
#         password: ${{ secrets.PYPI_TOKEN }}
#   Actions secretsé…ç½®:
#   Repo -> Settings -> Actions secrets and variables -> Repository secrets
# (2)é€šè¿‡PyPI with a Trusted Publisherçš„å‘å¸ƒæ–¹å¼:
#   è¯¦ç»†å‚è§æ•™ç¨‹ï¼šhttps://docs.pypi.org/trusted-publishers/
#   åªè¦åœ¨pypié‡Œå¯¹åŒ…æˆæƒpublishå°±è¡Œäº†ã€‚
#   # Specifying a GitHub environment is optional, but strongly encouraged
#   environment: release
#   permissions:
#     # IMPORTANT: this permission is mandatory for trusted publishing
#     id-token: write
#
# ä¸‹é¢æ–¹å¼ä½¿ç”¨ Trusted Publisher å‘å¸ƒ:
name: Publish PackageğŸ“¦ To PyPI

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # åœ¨ä»“åº“pushæ—¶è§¦å‘
  #push:
  #  #branches:
  #  #  - main
  #  # æ¨é€ tag æ˜¯ v*.*.*æ—¶è§¦å‘
  #  tags:
  #    - "v*.*.*"

  # åœ¨releaseæ—¶è§¦å‘
  release:
    types: [published]

# è®¾ç½®å·¥ä½œæµè®¿é—®ä»“åº“çš„æƒé™ï¼šåªè¯»ã€‚
permissions:
  contents: read

jobs:
  publish_python_package_to_pypi:
    name: Publish Package To PyPI
    environment: pypi
    permissions:
      # IMPORTANT: this permission is mandatory for trusted publishing
      id-token: write
    # åªåœ¨æ¨é€tagæ—¶ï¼Œæ‰å‘å¸ƒåˆ° PyPI
    #if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      # clone ä»“åº“
      - name: Checkout Code
        uses: actions/checkout@v4

      # è®¾ç½® Pythonç¯å¢ƒå’Œç‰ˆæœ¬
      - name: Setup Python ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv

      - name: Build
        run: |
          #poetry self add "poetry-dynamic-versioning[plugin]"
          [ -f dist ] && rm -rvf dist
          uv build

      - name: Publish Distribution ğŸ“¦ To PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        #with:
        #  password: ${{ secrets.PYPI_TOKEN }}
