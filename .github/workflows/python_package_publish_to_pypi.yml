# é€šè¿‡ Github actionsï¼š
#   è‡ªåŠ¨Pythonæ‰“åŒ…æ¨é€åˆ°PyPI
# Actions secretsé…ç½®:
# Repo -> Settings -> Actions secrets and variables -> Repository secrets
name: Publish Python ğŸ Package ğŸ“¦ To PyPI


on:
  # æ‰‹åŠ¨è§¦å‘
  #workflow_dispatch:

  # åœ¨ä»“åº“pushæ—¶è§¦å‘
  push:
    #branches:
    #  - main

    # æ¨é€ tag æ˜¯ v*.*.*æ—¶è§¦å‘
    tags:
      - "v*.*.*"

  # åœ¨releaseæ—¶è§¦å‘
  #release:
  #  types: [published]


# è®¾ç½®å·¥ä½œæµè®¿é—®ä»“åº“çš„æƒé™ï¼šåªè¯»ã€‚
permissions:
  contents: read


jobs:
  publish_python_package_to_pypi:
    name: Publish Package To PyPI
    # åªåœ¨æ¨é€tagæ—¶ï¼Œæ‰å‘å¸ƒåˆ° PyPI
    #if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      # clone ä»“åº“
      - name: Checkout Code
        uses: actions/checkout@v4

      # è®¾ç½® Pythonç¯å¢ƒå’Œç‰ˆæœ¬
      - name: Setup Python ğŸ 
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Build
        run: |
          #poetry self add "poetry-dynamic-versioning[plugin]"
          [ -f dist ] && rm -rvf dist
          poetry build

      - name: Publish Distribution ğŸ“¦ To PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}

